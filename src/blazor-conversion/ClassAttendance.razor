@page "/attendance/{ClassId:int}"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using ITendance.BlazorApp.Data.Services
@inject AttendanceService AttendanceService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Class Attendance - ITendance v2.0</PageTitle>

<!-- Breadcrumb Navigation -->
<MudBreadcrumbs Items="_breadcrumbItems" Style="padding: 0; margin-bottom: 16px;">
    <ItemTemplate Context="item">
        <MudLink Href="@item.Href" Style="color: #0066A1; font-size: 0.875rem;">
            @if (item.Icon != null)
            {
                <MudIcon Icon="@item.Icon" Size="Size.Small" Class="mr-1" />
            }
            @item.Text
        </MudLink>
    </ItemTemplate>
    <SeparatorTemplate>
        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Size="Size.Small" Style="color: #6B7280;" />
    </SeparatorTemplate>
</MudBreadcrumbs>

<MudDivider Class="mb-4" />

<!-- Page Header -->
<div class="d-flex justify-space-between align-center mb-4">
    <div style="border-left: 4px solid #003B5C; padding-left: 16px; flex: 1;">
        <div class="mb-2">
            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.ArrowBack"
                       Size="Size.Small"
                       Style="border: 2px solid #003B5C; color: #003B5C; border-radius: 0;"
                       Href="/">
                Back to Classes
            </MudButton>
        </div>
        <MudText Typo="Typo.h4" Style="color: #003B5C; margin-bottom: 4px;">@_className</MudText>
        <MudText Typo="Typo.body2" Style="color: #6B7280;">
            @_gradeLevel â€¢ Instructor: @_teacherName
        </MudText>
    </div>
    
    @if (_hasUnsavedChanges)
    {
        <MudButton Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Save"
                   Style="background-color: #F26522; color: white; border: 2px solid #F26522; border-radius: 0;"
                   OnClick="SaveAttendance">
            Save Attendance Changes
        </MudButton>
    }
</div>

<!-- Date Selector and Stats -->
<MudPaper Elevation="1" Square="true" Class="mb-4" Style="border: 2px solid #E8F4F8;">
    <div class="pa-3" style="background-color: #F5F5F5; border-bottom: 2px solid #003B5C;">
        <MudText Typo="Typo.body2" Style="color: #003B5C;">
            Attendance Summary for @_selectedDate.ToLongDateString()
        </MudText>
    </div>
    <div class="pa-4">
        <MudGrid Spacing="3">
            <!-- Date Selector -->
            <MudItem xs="12" md="2">
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: #F5F5F5; border: 2px solid #E8F4F8;">
                    <MudText Typo="Typo.caption" Class="mb-2" Style="color: #6B7280;">Select Date</MudText>
                    <MudDatePicker @bind-Date="_selectedDate"
                                   MaxDate="DateTime.Today"
                                   DateChanged="OnDateChanged"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Style="border: 2px solid #E8F4F8;" />
                </MudPaper>
            </MudItem>

            <!-- Stats Cards -->
            <MudItem xs="6" md="2">
                <MudPaper Elevation="0" Class="pa-3 text-center" 
                          Style="border: 2px solid #E8F4F8; border-left: 4px solid #22C55E;">
                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Present</MudText>
                    <MudText Typo="Typo.h4" Style="color: #22C55E;">@_stats.Present</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="2">
                <MudPaper Elevation="0" Class="pa-3 text-center" 
                          Style="border: 2px solid #E8F4F8; border-left: 4px solid #DC2626;">
                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Absent</MudText>
                    <MudText Typo="Typo.h4" Style="color: #DC2626;">@_stats.Absent</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="2">
                <MudPaper Elevation="0" Class="pa-3 text-center" 
                          Style="border: 2px solid #E8F4F8; border-left: 4px solid #F26522;">
                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Late</MudText>
                    <MudText Typo="Typo.h4" Style="color: #F26522;">@_stats.Late</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="2">
                <MudPaper Elevation="0" Class="pa-3 text-center" 
                          Style="border: 2px solid #E8F4F8; border-left: 4px solid #0066A1;">
                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Excused</MudText>
                    <MudText Typo="Typo.h4" Style="color: #0066A1;">@_stats.Excused</MudText>
                </MudPaper>
            </MudItem>

            <!-- Bulk Actions -->
            <MudItem xs="12" md="2">
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: #F5F5F5; border: 2px solid #E8F4F8;">
                    <MudText Typo="Typo.caption" Class="mb-2" Style="color: #6B7280;">Quick Actions</MudText>
                    <MudStack Spacing="1">
                        <MudButton Variant="Variant.Filled"
                                   Size="Size.Small"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                   Style="background-color: #22C55E; color: white; border-radius: 0;"
                                   OnClick="MarkAllPresent">
                            Mark All Present
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Cancel"
                                   Style="border: 2px solid #DC2626; color: #DC2626; border-radius: 0;"
                                   OnClick="MarkAllAbsent">
                            Mark All Absent
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </div>
</MudPaper>

<!-- Attendance Table - Inline Editing -->
<MudPaper Elevation="1" Square="true" Style="border: 2px solid #E8F4F8;">
    <div class="pa-3" style="background-color: #F5F5F5; border-bottom: 2px solid #003B5C;">
        <MudText Typo="Typo.body2" Style="color: #003B5C;">Student Attendance Records - Click to Mark</MudText>
    </div>

    <MudDataGrid T="StudentAttendanceRow" 
                 Items="@_attendanceRecords"
                 Dense="true"
                 Hover="true"
                 Bordered="true"
                 Striped="true"
                 FixedHeader="true"
                 Height="600px"
                 Style="--mud-palette-table-hover: #F3F4F6; --mud-palette-table-striped: #F9FAFB;">
        <Columns>
            <PropertyColumn Property="x => x.StudentId" Title="Student ID" />
            
            <PropertyColumn Property="x => x.StudentName" Title="Student Name">
                <CellTemplate>
                    <div class="d-flex align-center gap-2">
                        <span>@context.Item.StudentName</span>
                        @if (context.Item.IsAtRisk)
                        {
                            <MudTooltip Text="@GetAtRiskTooltip(context.Item)">
                                <MudChip Size="Size.Small" 
                                         Style="background-color: #FEF2F2; border: 2px solid #DC2626; color: #DC2626; height: 24px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                    @context.Item.RecentAbsences Absences
                                </MudChip>
                            </MudTooltip>
                        }
                    </div>
                </CellTemplate>
            </PropertyColumn>

            <TemplateColumn Title="Present" CellStyle="text-align: center; width: 100px;">
                <CellTemplate>
                    <MudCheckBox T="bool" 
                                 Checked="@(context.Item.Status == "Present")"
                                 CheckedChanged="@((bool value) => UpdateStatus(context.Item, value ? "Present" : "Absent"))"
                                 Color="Color.Success"
                                 Size="Size.Medium" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Absent" CellStyle="text-align: center; width: 100px;">
                <CellTemplate>
                    <MudCheckBox T="bool" 
                                 Checked="@(context.Item.Status == "Absent")"
                                 CheckedChanged="@((bool value) => UpdateStatus(context.Item, value ? "Absent" : "Present"))"
                                 Color="Color.Error"
                                 Size="Size.Medium" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Late" CellStyle="text-align: center; width: 100px;">
                <CellTemplate>
                    <MudCheckBox T="bool" 
                                 Checked="@(context.Item.Status == "Late")"
                                 CheckedChanged="@((bool value) => UpdateStatus(context.Item, value ? "Late" : "Present"))"
                                 Color="Color.Warning"
                                 Size="Size.Medium" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Excused" CellStyle="text-align: center; width: 100px;">
                <CellTemplate>
                    <MudCheckBox T="bool" 
                                 Checked="@(context.Item.Status == "Excused")"
                                 CheckedChanged="@((bool value) => UpdateStatus(context.Item, value ? "Excused" : "Present"))"
                                 Color="Color.Info"
                                 Size="Size.Medium" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Notes" CellStyle="width: 250px;">
                <CellTemplate>
                    <MudTextField @bind-Value="context.Item.Notes"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Placeholder="Add note..."
                                  OnBlur="@(() => OnNotesChanged())"
                                  Style="font-size: 0.75rem;" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    <div class="pa-3" style="background-color: #F5F5F5; border-top: 2px solid #E8F4F8;">
        <div class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.caption" Style="color: #6B7280;">
                Total Records: @_attendanceRecords.Count
            </MudText>
            @if (_hasUnsavedChanges)
            {
                <MudText Typo="Typo.caption" Style="color: #F26522;">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" /> Unsaved changes - Click Save button above
                </MudText>
            }
        </div>
    </div>
</MudPaper>

@code {
    [Parameter]
    public int ClassId { get; set; }

    private List<BreadcrumbItem> _breadcrumbItems = new();
    private List<StudentAttendanceRow> _attendanceRecords = new();
    private DateTime? _selectedDate = DateTime.Today;
    private bool _hasUnsavedChanges = false;
    private string _className = "";
    private string _gradeLevel = "";
    private string _teacherName = "";

    private AttendanceStats _stats = new();

    protected override async Task OnInitializedAsync()
    {
        // Load class info and attendance data
        await LoadClassInfo();
        await LoadAttendanceData();
        UpdateBreadcrumbs();
    }

    private async Task LoadClassInfo()
    {
        // Replace with actual service call
        _className = "Mathematics 101";
        _gradeLevel = "10th Grade";
        _teacherName = "Mr. Johnson";
    }

    private async Task LoadAttendanceData()
    {
        // Replace with actual service call
        // For demo purposes, creating sample data
        _attendanceRecords = new List<StudentAttendanceRow>
        {
            new() { StudentId = "STU001", StudentName = "Alex Anderson", Status = "Present", IsAtRisk = false, RecentAbsences = 0, Notes = "" },
            new() { StudentId = "STU002", StudentName = "Beth Brown", Status = "Present", IsAtRisk = false, RecentAbsences = 1, Notes = "" },
            new() { StudentId = "STU003", StudentName = "Carlos Chen", Status = "Present", IsAtRisk = true, RecentAbsences = 4, Notes = "" },
            new() { StudentId = "STU004", StudentName = "Diana Davis", Status = "Present", IsAtRisk = false, RecentAbsences = 0, Notes = "" },
            new() { StudentId = "STU005", StudentName = "Ethan Evans", Status = "Present", IsAtRisk = false, RecentAbsences = 2, Notes = "" },
        };
        
        CalculateStats();
    }

    private async Task OnDateChanged(DateTime? newDate)
    {
        if (newDate.HasValue)
        {
            _selectedDate = newDate;
            await LoadAttendanceData();
            _hasUnsavedChanges = false;
        }
    }

    private void UpdateStatus(StudentAttendanceRow student, string newStatus)
    {
        student.Status = newStatus;
        _hasUnsavedChanges = true;
        CalculateStats();
        StateHasChanged();
    }

    private void OnNotesChanged()
    {
        _hasUnsavedChanges = true;
    }

    private void MarkAllPresent()
    {
        foreach (var student in _attendanceRecords)
        {
            student.Status = "Present";
        }
        _hasUnsavedChanges = true;
        CalculateStats();
        Snackbar.Add("All students marked as Present", Severity.Success);
    }

    private void MarkAllAbsent()
    {
        foreach (var student in _attendanceRecords)
        {
            student.Status = "Absent";
        }
        _hasUnsavedChanges = true;
        CalculateStats();
        Snackbar.Add("All students marked as Absent", Severity.Warning);
    }

    private async Task SaveAttendance()
    {
        // Save to database
        // await AttendanceService.SaveAttendanceAsync(_attendanceRecords, _selectedDate.Value);
        
        Snackbar.Add("Attendance saved successfully!", Severity.Success);
        _hasUnsavedChanges = false;
    }

    private void CalculateStats()
    {
        _stats = new AttendanceStats
        {
            Present = _attendanceRecords.Count(r => r.Status == "Present"),
            Absent = _attendanceRecords.Count(r => r.Status == "Absent"),
            Late = _attendanceRecords.Count(r => r.Status == "Late"),
            Excused = _attendanceRecords.Count(r => r.Status == "Excused")
        };
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbItems = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem("My Classes", href: "/"),
            new BreadcrumbItem(_className, href: null, disabled: true)
        };
    }

    private string GetAtRiskTooltip(StudentAttendanceRow student)
    {
        return $"Recent absences (last 10 days): {student.RecentAbsences} days";
    }

    // Sample models
    private class StudentAttendanceRow
    {
        public string StudentId { get; set; } = "";
        public string StudentName { get; set; } = "";
        public string Status { get; set; } = "Present";
        public string Notes { get; set; } = "";
        public bool IsAtRisk { get; set; }
        public int RecentAbsences { get; set; }
    }

    private class AttendanceStats
    {
        public int Present { get; set; }
        public int Absent { get; set; }
        public int Late { get; set; }
        public int Excused { get; set; }
    }
}